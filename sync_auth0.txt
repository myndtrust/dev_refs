# Generated by Django 3.2.12 on 2022-05-19 00:03

from django.db import migrations
import json
import http.client

def migrate_users(apps, schema_editor):
    Auth0 = apps.get_model('skape_api', 'Auth0')
    conn = http.client.HTTPSConnection("dev-vsindmtt.us.auth0.com")

    payload = "{\"client_id\":\"JbSfA6mbEtIXdylsHfAwbLxeK0cxUvFx\",\"client_secret\":\"YaKPJYa1cEaSqmw-PG59DDFVJr-Iptohs0Nxg7OomYCBpdZC7MXdu6fxv_8lcnu_\",\"audience\":\"https://dev-vsindmtt.us.auth0.com/api/v2/\",\"grant_type\":\"client_credentials\"}"

    headers = { 'content-type': "application/json" }

    conn.request("POST", "/oauth/token", payload, headers)

    res = conn.getresponse()
    data = res.read()
    decoded_data = data.decode("utf-8")


    access_token = json.loads(decoded_data)["access_token"]

    '''
    https://auth0.com/docs/manage-users/user-search/retrieve-users-with-get-users-endpoint
    '''

    header_auth = "Bearer " + access_token

    # conn = http.client.HTTPSConnection("")

    headers = { 'authorization': header_auth }

    conn.request("GET", "/api/v2/users", headers=headers)

    res_users = conn.getresponse()
    data_users = res_users.read()

    users_json = data_users.decode("utf-8")

    for i in range(len(json.loads(users_json))):
        _auth0_user_id_synced = json.loads(users_json)[i]['user_id']
        try:
            _first_name = json.loads(users_json)[i]['given_name']
        except:
            _first_name = 'Skapebook needs your name.'
        _email = json.loads(users_json)[i]['email']
        _provider = json.loads(users_json)[i]['identities'][0]['provider']
        _image_url = json.loads(users_json)[i]["picture"]
        
        Auth0(auth0_user_id_synced=_auth0_user_id_synced,first_name=_first_name, email=_email, provider=_provider, image_url=_image_url).save()
        # User(email=_email).save()



class Migration(migrations.Migration):

    dependencies = [
    	('skape_api', '0002_auth0user'),
    ]

    operations = [
        migrations.RunPython(migrate_users),
    ]
